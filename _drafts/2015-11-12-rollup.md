---
layout: post
title: 'Rollup'
date: 2015-11-12 08:33:05
tags:
- ruby on rails
- clojure
- haml
tumblr_url: http://crowdhailer.tumblr.com/post/80766441344/makers-acadamy-wandering-in-the-wild
---
Rollup.js is a great way to break up large client side code base.

You might not be wanting to tackle all of es6 yet still want to separate your JavaScript code into modules. Previously the best way to do this was browserify. Rollup is the logical next step as it replaces the commonjs modules with es6 modules. It is also a component of Babel (a full es6 transpiler) so there is an easy upgrade path if and when you move on.

I have recently introduced Rollup into my development workflow. It is easy to integrate with existing tools for testing.
I use the Karma test runner to execute my test framework of choice, which is currently Jasmine. This post walks through my setup of Jasmine, Karma and rollup. Want to jump straight to the code? Visit this repository to see the code.

*I will assume that you already have node and npm installed, need help see [ssdsds]()*

### Setting up your node project

We first need to create a `package.json` file to identify our project as a node project. This can be done by hand or by executing `npm init`. At the moment the only thing we need is to give the project a name, lets call it calculator.

Now we can fetch the development dependencies we are setting up. We do this by executing the following installed

{% highlight sh %}
```sh
$ npm install --save-dev \
    rollup \
    jasmine \
    karma \
    karma-jasmine \
    karma-firefox-launcher
```
{% endhighlight %}

At this point make sure that you have added `node_modules` to your `.gitignore` file. It is not a good idea to commit all these node files to version control. Something that I have done on too many occasions.

### Setting up Karma

The Karma test runner also comes with a handy project initializer which will create a `karma.conf.js` file.
Run the karma initializer with the following options.

{% highlight sh %}
```sh
$  ./node_modules/.bin/karma init

Which testing framework do you want to use ?
Press tab to list possible options. Enter to move to the next question.
> jasmine

Do you want to use Require.js ?
This will add Require.js plugin.
Press tab to list possible options. Enter to move to the next question.
> no

Do you want to capture any browsers automatically ?
Press tab to list possible options. Enter empty string to move to the next question.
> Firefox
>

What is the location of your source and test files ?
You can use glob patterns, eg. "js/*.js" or "test/**/*Spec.js".
Enter empty string to move to the next question.
> test/bundle.js
11 11 2015 17:04:52.298:WARN [init]: There is no file matching this pattern.

>

Should any of the files included by the previous patterns be excluded ?
You can use glob patterns, eg. "**/*.swp".
Enter empty string to move to the next question.
>

Do you want Karma to watch all the files and run the tests on change ?
Press tab to list possible options.
> no


Config file generated at "/home/peter/Projects/Calculator/karma.conf.js".
```
{% endhighlight %}

- We do not need Require.js as we will be replacing this with Rollup.js
- You can select any browser from the list just make sure that you have installed the correct browser runner.
- Don't worry about the missing test file, we will add it shortly.
- It would be nice to be able to watch our test files. Unfortunately I do not know how to do this yet with Rollup.js.

### Creating our first test.

Lets create a single test to check out karma setup.
We will create a main test file and add the example jasmine test to it.

{% highlight js %}
```js
// test/main.js

describe("A suite", function() {
  it("contains spec with an expectation", function() {
    expect(true).toBe(true);
  });
});
```
{% endhighlight %}

To bundle this file where we can test it we use rollup with its default settings.

{% highlight sh %}
```sh
$ ./node_modules/.bin/rollup test/main.js > test/bundle.js
```
{% endhighlight %}

Now our bundle is available we can run our single test.

{% highlight sh %}
```sh
$ ./node_modules/.bin/karma start --singleRun
```
{% endhighlight %}

This will show one passing test.
As `test/bundle.js` is just a derived file it does not belong in version control.
Add a line for it in the `.gitignore`.

### Simple test execution

Typing all those commands in to execute the tests would be painful.
We can make life much easier by declaring them as npm scripts.
First lets make one change to `karma.conf.js`, we will set our singleRun configuration to be true.

{% highlight js %}
```js
// karma.conf.js

module.exports = function(config) {
  config.set({
    // Continuous Integration mode
    // if true, Karma captures browsers, runs the tests and exits
    singleRun: true,
  });
};
```
{% endhighlight %}

Alot of functionality can end up in npm scripts and it is easy to write magical single line scripts that noone understands.
My advice is don't do this, we will write separate scripts for building and running the tests. Then have a third function that utilises these.

{% highlight json %}
```json
// package.json
{
  "scripts": {
    "test": "npm run -s test:build && npm run -s test:run",
    "test:build": "rollup ./test/main.js > test/bundle.js",
    "test:run": "karma start"
  },
}
```
{% endhighlight %}

This leaves us with a single easy to remember test command.

{% highlight sh %}
```sh
$ npm -s test
```
{% endhighlight %}

Having a trivial test command is important if you ever hope to actually test drive the development of a project.
Running this now and there should still be one passing test.

### Testing some real code

So our test as it stands is not very interesting.
It is time to test some real code for a calculator.
The first feature to add to our calculator is to be able to add two numbers.
lets adjust the test file so that it imports the calculator and add a meaningful test.

{% highlight js %}
```js
// test/main.js

// Import all exported functions from the calculator source file
// They will be available as part of the calculator namespace
import * as calculator from "../src/calculator";

describe("A Calculator", function() {
  it("should be able to add two numbers", function() {
    expect(calculator.add(1, 2)).toEqual(3);
  });
});
```
{% endhighlight %}

The tests should now be failing, there is no code after all.
Assuming that are calculator will gain features lets separate the representation of the whole calculator from the implementation of each piece of functionality.

{% highlight js %}
```js
// src/calculator.js

// Import add from the `calculator/add.js` file
import add from "./calculator/add";

// Export add as one of the exports for the calculator module
export { add };
```
{% endhighlight %}

{% highlight js %}
```js
// src/calculator/add.js

// export the function add as the default for this module
export default function add(a, b) { return a + b; }
```
{% endhighlight %}

### Building a distribution

The final thing now we have a working calculator is to bundle the source into a single file.
This is so it can be utilitised in all those browsers that are not yet supporting es6 modules.

Using rollup to build our distribution to execute the bundle.

{% highlight sh %}
```sh
$ ./node_modules/.bin/rollup \
    --format iife \
    --name calculator \
    src/calculator.js

(function (exports) { 'use strict';

	function add(a, b) { return a + b; }

	exports.add = add;

})((this.calculator = {}));
```
{% endhighlight %}

We pass the format and name options to that our final bundle is available in the global namespace and can be used by other js code.

As just printing our bundle to the console doesn't let anyone use it we need to store the result somewhere.
The final steps are; first to create a npm script to bundle the source and save it in `index.js`, second to add index.js to `.gitignore`.

### Next steps
view the whole repo
be able to run the test as a watch task
notify
